{% extends 'base.html' %}
{% block content %}
<h2>Проект: {{ project.name }}</h2>

<!-- Информация о проекте -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <p><strong>Месяц:</strong> {{ project.month.name if project.month }}</p>
            </div>
            <div class="col-md-4">
                <p><strong>Рекламодатель:</strong> {{ project.advertiser.name if project.advertiser else 'Не указан' }}</p>
            </div>
            <div class="col-md-4">
                <p><strong>Описание:</strong> {{ project.description or '---' }}</p>
            </div>
        </div>
        <!-- Кнопки управления проектом -->
        <div class="mt-3">
            <a href="/project/{{ project.id }}/edit" class="btn btn-primary">Редактировать проект</a>
            <form action="/project/{{ project.id }}/delete" method="post" style="display:inline;">
                <button class="btn btn-danger" onclick="return confirm('Удалить проект {{ project.name }}?')">Удалить проект</button>
            </form>
        </div>
    </div>
</div>

<hr>
<h4>Сделки в проекте <a href="/order/add?project_id={{ project.id }}" class="btn btn-sm btn-success">Добавить сделку</a></h4>

{% if orders %}
    <table class="table table-sm table-striped">
        <thead>
            <tr>
                <th>Дата</th>
                <th>Блогер</th>
                <th>Контакты</th>  <!-- ✅ ДОБАВЛЕНО -->
                <th>РКН</th>       <!-- ✅ ДОБАВЛЕНО -->
                <th>Продукт</th>
                <th>Стоимость</th>
                <th>Блогеру</th>
                <th>Прибыль</th>
                <th>Статус</th>
                <th>Заметки</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for o in orders %}
                <tr id="order-{{ o.id }}">
                    <td>{{ o.date.strftime('%d.%m.%Y') if o.date else '' }}</td>
                    <td>{{ o.blogger.name if o.blogger }}</td>
                    <td>
                        {% if o.blogger and o.blogger.telegram %}
                            <a href="https://t.me/{{ o.blogger.telegram }}" target="_blank" class="text-decoration-none">
                                @{{ o.blogger.telegram }}
                            </a>
                        {% else %}
                            <span class="text-muted">---</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if o.blogger and o.blogger.rkn %}
                            <span class="badge bg-warning">РКН</span>
                        {% else %}
                            <span class="text-muted">---</span>
                        {% endif %}
                    </td>
                    <td>{{ o.product }}</td>
                    <td>{{ "%.0f"|format(o.cost) if o.cost else '0' }} ₽</td>
                    <td>{{ "%.0f"|format(o.blogger_fee) if o.blogger_fee else '0' }} ₽</td>
                    <td>{{ "%.0f"|format(o.cost - o.blogger_fee) if o.cost else '0' }} ₽</td>
                    <td>
                      {% if o.status == 'negotiation' %}
                        <span class="badge bg-warning">На согласовании</span>
                      {% elif o.status == 'agreed' %}
                        <span class="badge bg-primary">Согласован</span>
                      {% elif o.status == 'paid' %}
                        <span class="badge bg-success">Опл</span>
                      {% elif o.status == 'published' %}
                        <span class="badge bg-info">Выложил</span>
                      {% endif %}
                    </td>
                    <td>
                      <!-- Редактируемое поле заметок -->
                      <div class="notes-cell">
                        <div class="notes-view">
                          <small class="notes-text" 
                                 onclick="enableEdit({{ o.id }})"
                                 style="cursor: pointer;"
                                 title="Кликните для редактирования">
                            {% if o.notes %}
                              {{ o.notes[:30] }}{% if o.notes|length > 30 %}...{% endif %}
                            {% else %}
                              <span class="text-muted">+ добавить заметку</span>
                            {% endif %}
                          </small>
                        </div>
                        <div class="notes-edit" style="display: none;">
                          <textarea class="form-control form-control-sm notes-textarea" 
                                    id="notes-{{ o.id }}" 
                                    rows="2">{{ o.notes or '' }}</textarea>
                          <div class="mt-1">
                            <button class="btn btn-sm btn-success" onclick="saveNotes({{ o.id }})">✓</button>
                            <button class="btn btn-sm btn-secondary" onclick="cancelEdit({{ o.id }})">✕</button>
                          </div>
                        </div>
                      </div>
                    </td>
                    <td>
                        <a href="/order/{{ o.id }}/edit" class="btn btn-sm btn-secondary">Ред.</a>
                        <form action="/order/{{ o.id }}/delete" method="post" style="display:inline;">
                            <button class="btn btn-sm btn-danger" onclick="return confirm('Удалить сделку?')">X</button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <p class="text-muted">Нет сделок в этом проекте</p>
{% endif %}

<style>
.notes-cell {
  min-width: 150px;
  max-width: 200px;
}
.notes-text {
  word-break: break-word;
}
.notes-textarea {
  font-size: 0.875em;
  resize: vertical;
}
</style>

<script>
function enableEdit(orderId) {
  document.querySelectorAll('.notes-edit').forEach(el => {
    el.style.display = 'none';
  });
  document.querySelectorAll('.notes-view').forEach(el => {
    el.style.display = 'block';
  });
  
  const row = document.getElementById('order-' + orderId);
  row.querySelector('.notes-view').style.display = 'none';
  row.querySelector('.notes-edit').style.display = 'block';
  row.querySelector('.notes-textarea').focus();
}

function cancelEdit(orderId) {
  const row = document.getElementById('order-' + orderId);
  row.querySelector('.notes-view').style.display = 'block';
  row.querySelector('.notes-edit').style.display = 'none';
}

function saveNotes(orderId) {
  const textarea = document.getElementById('notes-' + orderId);
  const notes = textarea.value.trim();
  
  fetch('/order/' + orderId + '/notes', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      notes: notes
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const notesView = document.querySelector('#order-' + orderId + ' .notes-text');
      if (notes) {
        notesView.textContent = notes.length > 30 ? notes.substring(0, 30) + '...' : notes;
        notesView.classList.remove('text-muted');
      } else {
        notesView.innerHTML = '<span class="text-muted">+ добавить заметку</span>';
      }
      
      cancelEdit(orderId);
      showNotification('Заметка сохранена!', 'success');
    } else {
      showNotification('Ошибка сохранения', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('Ошибка сохранения', 'error');
  });
}

function showNotification(message, type) {
  const alert = document.createElement('div');
  alert.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
  alert.style.position = 'fixed';
  alert.style.top = '20px';
  alert.style.right = '20px';
  alert.style.zIndex = '1000';
  alert.innerHTML = `
    ${message}
    <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
  `;
  document.body.appendChild(alert);
  
  setTimeout(() => {
    if (alert.parentElement) {
      alert.remove();
    }
  }, 3000);
}
</script>
{% endblock %}