{% extends 'base.html' %}
{% block content %}

<h2>{% if project %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç{% else %}–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç{% endif %}</h2>

<form method="post" id="projectForm" onsubmit="return validateForm()">
  {{ form.hidden_tag() }}
  
  <div class="mb-3">
    {{ form.name.label(class_='form-label') }}
    {{ form.name(class_='form-control', id='projectName') }}
    {% if form.name.errors %}
      <div class="text-danger">{{ form.name.errors[0] }}</div>
    {% endif %}
  </div>

  <div class="mb-3">
    <label class="form-label">–†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å *</label>
    <select name="advertiser_id" class="form-control" id="advertiserSelect" required>
      <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—è --</option>
      {% if not project %}
        <option value="0">-- –ù–æ–≤—ã–π —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å --</option>
      {% endif %}
      {% for advertiser in advertisers %}
        <option value="{{ advertiser.id }}" 
                {% if (project and project.advertiser_id == advertiser.id) or (request.form.get('advertiser_id')|int == advertiser.id) %}selected{% endif %}>
          {{ advertiser.name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- –ü–æ–ª—è –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—è -->
  {% if not project %}
  <div id="newAdvertiserFields" style="display: none;" class="border p-3 mb-3 rounded">
    <h6>–ù–æ–≤—ã–π —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å</h6>
    <div class="mb-2">
      <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ *</label>
      <input type="text" name="new_advertiser_name" class="form-control" id="newAdvertiserName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
    </div>
    <div class="mb-2">
      <label class="form-label">Telegram</label>
      <input type="text" name="new_advertiser_telegram" class="form-control" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ">
    </div>
  </div>
  {% endif %}

  <!-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ –º–µ—Å—è—Ü—É –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω month_id -->
  {% if preselected_month_id %}
    <input type="hidden" name="month_id" value="{{ preselected_month_id }}">
    <div class="alert alert-info">
      <strong>–ü—Ä–æ–µ–∫—Ç –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –≤ –º–µ—Å—è—Ü–µ:</strong> 
      {% for month in months %}
        {% if month.id == preselected_month_id %}{{ month.name }}{% endif %}
      {% endfor %}
    </div>
  {% else %}
    <!-- –í—ã–±–æ—Ä –º–µ—Å—è—Ü–∞ -->
    <div class="mb-3">
      <label class="form-label">–ú–µ—Å—è—Ü *</label>
      <select name="month_id" class="form-control" required>
        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü --</option>
        {% for month in months %}
          <option value="{{ month.id }}" 
                  {% if (project and project.month_id == month.id) or (request.form.get('month_id')|int == month.id) %}selected{% endif %}>
            {{ month.name }}
          </option>
        {% endfor %}
      </select>
    </div>
  {% endif %}
  
  <div class="mb-3">
    {{ form.description.label(class_='form-label') }}
    {{ form.description(class_='form-control', rows='4', placeholder='–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞') }}
  </div>
  
  <button type="submit" class="btn btn-primary" id="submitBtn">
    {% if project %}–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è{% else %}–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç{% endif %}
  </button>
  
  {% if project %}
    <a href="/project/{{ project.id }}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
  {% elif preselected_month_id %}
    <a href="/month/{{ preselected_month_id }}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
  {% else %}
    <a href="/projects" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
  {% endif %}
</form>

<script>
function toggleAdvertiserFields() {
  const advertiserSelect = document.getElementById('advertiserSelect');
  const newAdvertiserFields = document.getElementById('newAdvertiserFields');
  const newAdvertiserName = document.getElementById('newAdvertiserName');
  
  if (advertiserSelect && newAdvertiserFields) {
    if (advertiserSelect.value === '0') {
      newAdvertiserFields.style.display = 'block';
      if (newAdvertiserName) newAdvertiserName.required = true;
    } else {
      newAdvertiserFields.style.display = 'none';
      if (newAdvertiserName) newAdvertiserName.required = false;
    }
  }
}

function validateForm() {
  console.log('üîç –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã...');
  const advertiserSelect = document.getElementById('advertiserSelect');
  const projectName = document.getElementById('projectName');
  
  // –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
  if (!projectName.value.trim()) {
    alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞');
    return false;
  }
  
  if (!advertiserSelect.value) {
    alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—è');
    return false;
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤–æ–≥–æ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—è
  if (advertiserSelect.value === '0') {
    const newAdvertiserName = document.getElementById('newAdvertiserName');
    if (!newAdvertiserName || !newAdvertiserName.value.trim()) {
      alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—è');
      return false;
    }
  }
  
  console.log('‚úÖ –§–æ—Ä–º–∞ –≤–∞–ª–∏–¥–Ω–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º...');
  return true;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
  console.log('üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –ø—Ä–æ–µ–∫—Ç–∞');
  toggleAdvertiserFields();
  
  // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—è
  const advertiserSelect = document.getElementById('advertiserSelect');
  if (advertiserSelect) {
    advertiserSelect.addEventListener('change', toggleAdvertiserFields);
  }
  
  // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
  const submitBtn = document.getElementById('submitBtn');
  if (submitBtn) {
    submitBtn.addEventListener('click', function(e) {
      console.log('üñ±Ô∏è –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞–∂–∞—Ç–∞');
    });
  }
});
</script>
{% endblock %}