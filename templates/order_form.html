{% extends 'base.html' %}
{% block content %}
<h2>{% if request.path.startswith('/order/') and '/edit' in request.path %}Редактировать сделку{% else %}Добавить сделку{% endif %}</h2>
<form method="post">
    {{ form.hidden_tag() }}
    
    <!-- Блогер -->
    <div class="mb-3">
        {{ form.blogger.label(class_='form-label') }}
        {{ form.blogger(class_='form-control', onchange='toggleBloggerFields()') }}
    </div>
    
    <!-- Поля для нового блогера -->
    <div id="newBloggerFields" style="display: none;" class="border p-3 mb-3 rounded">
        <h6>Новый блогер</h6>
        <div class="mb-2">
            <label class="form-label">Имя блогера</label>
            <input type="text" name="new_blogger_name" class="form-control" placeholder="Введите имя блогера">
        </div>
        <div class="mb-2">
            <label class="form-label">Платформа</label>
            <select name="new_blogger_platform" class="form-control">
                <option value="tiktok">TikTok</option>
                <option value="tg">Telegram</option>
                <option value="insta">Instagram</option>
                <option value="youtube">YouTube</option>
            </select>
        </div>
        <div class="mb-2">
            <label class="form-label">Ссылка</label>
            <input type="text" name="new_blogger_link" class="form-control" placeholder="Необязательно">
        </div>
    </div>

    <!-- ✅ ИСПРАВЛЕНО: Показываем рекламодателя только если НЕТ проекта -->
    {% if not project %}
    <div class="mb-3">
        {{ form.advertiser.label(class_='form-label') }}
        {{ form.advertiser(class_='form-control', onchange='toggleAdvertiserFields()') }}
    </div>
    
    <!-- Поля для нового рекламодателя -->
    <div id="newAdvertiserFields" style="display: none;" class="border p-3 mb-3 rounded">
        <h6>Новый рекламодатель</h6>
        <div class="mb-2">
            <label class="form-label">Название компании</label>
            <input type="text" name="new_advertiser_name" class="form-control" placeholder="Введите название">
        </div>
        <div class="mb-2">
            <label class="form-label">Telegram</label>
            <input type="text" name="new_advertiser_telegram" class="form-control" placeholder="Необязательно">
        </div>
    </div>
    {% else %}
    <!-- ✅ ДОБАВЛЕНО: Показываем информацию о рекламодателе проекта -->
    <div class="alert alert-info">
        <strong>Рекламодатель проекта:</strong> {{ project.advertiser.name if project.advertiser else 'Не указан' }}
    </div>
    {% endif %}

    <!-- Основные поля -->
    <div class="mb-3">
        {{ form.date.label(class_='form-label') }}
        {{ form.date(class_='form-control', placeholder='25.12.2024 (необязательно)') }}
        {% if form.date.errors %}
            <div class="text-danger">{{ form.date.errors[0] }}</div>
        {% endif %}
    </div>

    <!-- ✅ ИСПРАВЛЕНО: Показываем поле проекта только если НЕТ проекта -->
    {% if not project %}
    <div class="mb-3">
        {{ form.project.label(class_='form-label') }}
        {{ form.project(class_='form-control') }}
        <div class="form-text">Оставьте пустым для сделки без проекта</div>
    </div>
    {% else %}
    <!-- ✅ ДОБАВЛЕНО: Показываем информацию о проекте -->
    <div class="alert alert-info">
        <strong>Проект:</strong> {{ project.name }}
    </div>
    <input type="hidden" name="project" value="{{ project.id }}">
    {% endif %}

    <div class="mb-3">
        {{ form.product.label(class_='form-label') }}
        {{ form.product(class_='form-control', placeholder='Название продукта или услуги') }}
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                {{ form.cost.label(class_='form-label') }}
                {{ form.cost(class_='form-control', placeholder='0') }}
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                {{ form.blogger_fee.label(class_='form-label') }}
                {{ form.blogger_fee(class_='form-control', placeholder='0') }}
            </div>
        </div>
    </div>

    <!-- Статус -->
    <div class="mb-3">
        {{ form.status.label(class_='form-label') }}
        {{ form.status(class_='form-control') }}
    </div>

    <!-- Заметки -->
    <div class="mb-3">
        {{ form.notes.label(class_='form-label') }}
        {{ form.notes(class_='form-control', rows='3', placeholder='Любые дополнительные заметки, комментарии, напоминания...') }}
        <div class="form-text">Можно оставить пустым</div>
    </div>

    <div class="mb-3">
        {{ form.link.label(class_='form-label') }}
        {{ form.link(class_='form-control', placeholder='Ссылка на опубликованный пост') }}
    </div>
    
    <button class="btn btn-primary">{% if request.path.startswith('/order/') and '/edit' in request.path %}Сохранить{% else %}Создать сделку{% endif %}</button>
    <a href="/orders" class="btn btn-secondary">Отмена</a>
</form>

<script>
function toggleBloggerFields() {
    const bloggerSelect = document.querySelector('#blogger');
    const newBloggerFields = document.getElementById('newBloggerFields');
    newBloggerFields.style.display = bloggerSelect.value === '0' ? 'block' : 'none';
}

// ✅ ИСПРАВЛЕНО: Функция только если есть поле рекламодателя
function toggleAdvertiserFields() {
    const advertiserSelect = document.querySelector('#advertiser');
    const newAdvertiserFields = document.getElementById('newAdvertiserFields');
    if (advertiserSelect && newAdvertiserFields) {
        newAdvertiserFields.style.display = advertiserSelect.value === '0' ? 'block' : 'none';
    }
}

// ✅ ИСПРАВЛЕНО: Убрана блокировка проекта, т.к. теперь поле скрыто
document.addEventListener('DOMContentLoaded', function() {
    toggleBloggerFields();
    toggleAdvertiserFields();
});
</script>
{% endblock %}