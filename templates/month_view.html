{% extends 'base.html' %}
{% block content %}
<h2>Месяц: {{ month.name }}</h2>

<div class="card mb-4">
    <div class="card-body">
        <h4>Проекты этого месяца 
            <a href="/project/add?month_id={{ month.id }}" class="btn btn-sm btn-success">Создать проект</a>
        </h4>
        
        {% if month.projects %}
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Название</th>
                        <th>Доход</th>  <!-- ✅ ИЗМЕНЕНО: Было "Статус" -->
                        <th>Сделок</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in month.projects %}
                        <tr>
                            <td>{{ p.name }}</td>
                            <td>
                                <!-- ✅ ДОБАВЛЕНО: Расчет дохода по проекту -->
                                {% set project_profit = p.orders|sum(attribute='cost') - p.orders|sum(attribute='blogger_fee') %}
                                <span class="badge bg-success">
                                    {{ "%.0f"|format(project_profit) if project_profit > 0 else '0' }} ₽
                                </span>
                            </td>
                            <td>{{ p.orders|length }}</td>
                            <td>
                                <a href="/project/{{ p.id }}" class="btn btn-sm btn-primary">Открыть</a>
                                <a href="/project/{{ p.id }}/edit" class="btn btn-sm btn-secondary">Ред.</a>
                                <form action="/project/{{ p.id }}/delete" method="post" style="display:inline;">
                                    <button class="btn btn-sm btn-danger" onclick="return confirm('Удалить проект {{ p.name }}?')">X</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="text-muted">Нет проектов в этом месяце</p>
            <a href="/project/add?month_id={{ month.id }}" class="btn btn-success">
                Создать проект в этом месяце
            </a>
        {% endif %}
    </div>
</div>

<!-- остальной код без изменений -->

<!-- ✅ ДОБАВЛЕН РАЗДЕЛ ДЛЯ СДЕЛОК БЕЗ ПРОЕКТА -->
<div class="card">
    <div class="card-body">
        <h4>Сделки без проекта 
            <a href="/order/add?month_id={{ month.id }}" class="btn btn-sm btn-success">Добавить сделку</a>
        </h4>
        
        {% if month.orders %}
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>Дата</th>
                        <th>Блогер</th>
                        <th>Рекламодатель</th>
                        <th>Контакты</th>
                        <th>РКН</th>
                        <th>Продукт</th>
                        <th>Стоимость</th>
                        <th>Блогеру</th>
                        <th>Прибыль</th>
                        <th>Статус</th>
                        <th>Заметки</th>  <!-- ✅ ДОБАВЛЕНА КОЛОНКА ЗАМЕТОК -->
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for o in month.orders %}
                        <tr id="order-{{ o.id }}">
                            <td>{{ o.date.strftime('%d.%m.%Y') if o.date else '' }}</td>
                            <td>{{ o.blogger.name if o.blogger else '---' }}</td>
                            <td>{{ o.advertiser.name if o.advertiser else '---' }}</td>
                            <td>
                                {% if o.blogger and o.blogger.telegram %}
                                    <a href="https://t.me/{{ o.blogger.telegram }}" target="_blank" class="text-decoration-none">
                                        @{{ o.blogger.telegram }}
                                    </a>
                                {% else %}
                                    <span class="text-muted">---</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if o.blogger and o.blogger.rkn %}
                                    <span class="badge bg-warning">РКН</span>
                                {% else %}
                                    <span class="text-muted">---</span>
                                {% endif %}
                            </td>
                            <td>{{ o.product }}</td>
                            <td>{{ "%.0f"|format(o.cost) if o.cost else '0' }} ₽</td>
                            <td>{{ "%.0f"|format(o.blogger_fee) if o.blogger_fee else '0' }} ₽</td>
                            <td>{{ "%.0f"|format(o.cost - o.blogger_fee) if o.cost else '0' }} ₽</td>
                            <td>
                                {% if o.status == 'negotiation' %}
                                    <span class="badge bg-warning">На согласовании</span>
                                {% elif o.status == 'agreed' %}
                                    <span class="badge bg-primary">Согласован</span>
                                {% elif o.status == 'paid' %}
                                    <span class="badge bg-success">Опл</span>
                                {% elif o.status == 'published' %}
                                    <span class="badge bg-info">Выложил</span>
                                {% endif %}
                            </td>
                            <td>
                                <!-- ✅ ДОБАВЛЕНЫ РЕДАКТИРУЕМЫЕ ЗАМЕТКИ -->
                                <div class="notes-cell">
                                    <div class="notes-view">
                                        <small class="notes-text" 
                                               onclick="enableEdit({{ o.id }})"
                                               style="cursor: pointer;"
                                               title="Кликните для редактирования">
                                            {% if o.notes %}
                                                {{ o.notes[:30] }}{% if o.notes|length > 30 %}...{% endif %}
                                            {% else %}
                                                <span class="text-muted">+ добавить заметку</span>
                                            {% endif %}
                                        </small>
                                    </div>
                                    <div class="notes-edit" style="display: none;">
                                        <textarea class="form-control form-control-sm notes-textarea" 
                                                  id="notes-{{ o.id }}" 
                                                  rows="2">{{ o.notes or '' }}</textarea>
                                        <div class="mt-1">
                                            <button class="btn btn-sm btn-success" onclick="saveNotes({{ o.id }})">✓</button>
                                            <button class="btn btn-sm btn-secondary" onclick="cancelEdit({{ o.id }})">✕</button>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <a href="/order/{{ o.id }}/edit" class="btn btn-sm btn-secondary">Ред.</a>
                                <form action="/order/{{ o.id }}/delete" method="post" style="display:inline;">
                                    <button class="btn btn-sm btn-danger" onclick="return confirm('Удалить сделку?')">X</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="text-muted">Нет сделок без проекта в этом месяце</p>
        {% endif %}
    </div>
</div>

<style>
.notes-cell {
  min-width: 150px;
  max-width: 200px;
}
.notes-text {
  word-break: break-word;
}
.notes-textarea {
  font-size: 0.875em;
  resize: vertical;
}
</style>

<script>
function enableEdit(orderId) {
  document.querySelectorAll('.notes-edit').forEach(el => {
    el.style.display = 'none';
  });
  document.querySelectorAll('.notes-view').forEach(el => {
    el.style.display = 'block';
  });
  
  const row = document.getElementById('order-' + orderId);
  row.querySelector('.notes-view').style.display = 'none';
  row.querySelector('.notes-edit').style.display = 'block';
  row.querySelector('.notes-textarea').focus();
}

function cancelEdit(orderId) {
  const row = document.getElementById('order-' + orderId);
  row.querySelector('.notes-view').style.display = 'block';
  row.querySelector('.notes-edit').style.display = 'none';
}

function saveNotes(orderId) {
  const textarea = document.getElementById('notes-' + orderId);
  const notes = textarea.value.trim();
  
  fetch('/order/' + orderId + '/notes', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      notes: notes
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const notesView = document.querySelector('#order-' + orderId + ' .notes-text');
      if (notes) {
        notesView.textContent = notes.length > 30 ? notes.substring(0, 30) + '...' : notes;
        notesView.classList.remove('text-muted');
      } else {
        notesView.innerHTML = '<span class="text-muted">+ добавить заметку</span>';
      }
      
      cancelEdit(orderId);
      showNotification('Заметка сохранена!', 'success');
    } else {
      showNotification('Ошибка сохранения', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('Ошибка сохранения', 'error');
  });
}

function showNotification(message, type) {
  const alert = document.createElement('div');
  alert.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
  alert.style.position = 'fixed';
  alert.style.top = '20px';
  alert.style.right = '20px';
  alert.style.zIndex = '1000';
  alert.innerHTML = `
    ${message}
    <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
  `;
  document.body.appendChild(alert);
  
  setTimeout(() => {
    if (alert.parentElement) {
      alert.remove();
    }
  }, 3000);
}
</script>
{% endblock %}