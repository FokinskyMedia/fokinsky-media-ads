{% extends 'base.html' %}
{% block content %}
<h2>–°–¥–µ–ª–∫–∏ <a href="/order/add" class="btn btn-sm btn-success">–î–æ–±–∞–≤–∏—Ç—å</a></h2>

<!-- –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–ê–ì–ò–ù–ê–¶–ò–ò -->
<div class="alert alert-info d-flex justify-content-between align-items-center py-2 mb-3">
    <small>
        üìä –ü–æ–∫–∞–∑–∞–Ω–æ: <strong>{{ orders.items|length }}</strong> –∏–∑ <strong>{{ orders.total }}</strong> —Å–¥–µ–ª–æ–∫
    </small>
    {% if orders.pages > 1 %}
    <small>
        üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞: <strong>{{ orders.page }}</strong> –∏–∑ <strong>{{ orders.pages }}</strong>
    </small>
    {% endif %}
</div>

<table class="table table-sm table-striped">
  <thead>
    <tr>
      <th>–î–∞—Ç–∞</th>
      <th>–ë–ª–æ–≥–µ—Ä</th>
      <th>–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>
      <th>–†–ö–ù</th>
      <th>–ü—Ä–æ–¥—É–∫—Ç</th>
      <th>–¶–µ–Ω–∞</th>
      <th>–ë–ª–æ–≥–µ—Ä—É</th>
      <th>–ü—Ä–∏–±—ã–ª—å</th>
      <th>–°—Ç–∞—Ç—É—Å</th>
      <th>–ó–∞–º–µ—Ç–∫–∏</th>
      <th>–î–µ–π—Å—Ç–≤–∏—è</th>
    </tr>
  </thead>
  <tbody>
    {% for o in orders.items %}
      <tr id="order-{{ o.id }}">
        <td>{{ o.date.strftime('%d.%m.%Y') if o.date else '' }}</td>
        <td>{{ o.blogger.name if o.blogger else '---' }}</td>
        <td>
  {% if o.blogger %}
    <div class="d-flex flex-column">
      {% if o.blogger.contact_link %}
        <a href="{{ o.blogger.contact_link }}" target="_blank" class="text-decoration-none" title="–ö–æ–Ω—Ç–∞–∫—Ç –±–ª–æ–≥–µ—Ä–∞">
          <i class="fab fa-telegram me-1"></i>–ö–æ–Ω—Ç–∞–∫—Ç—ã
        </a>
      {% elif o.blogger.telegram %}
        <a href="https://t.me/{{ o.blogger.telegram }}" target="_blank" class="text-decoration-none">
          @{{ o.blogger.telegram }}
        </a>
      {% else %}
        <span class="text-muted">---</span>
      {% endif %}
    </div>
  {% else %}
    <span class="text-muted">---</span>
  {% endif %}
</td>
<td>
  {% if o.blogger and o.blogger.rkn_info %}
    <a href="{{ o.blogger.rkn_info }}" target="_blank" class="badge bg-warning" title="–†–ö–ù –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">
      –†–ö–ù
    </a>
  {% else %}
    <span class="text-muted">---</span>
  {% endif %}
</td>
        <td>{{ o.product }}</td>
        <td>{{ "%.0f"|format(o.cost) if o.cost else '0' }} ‚ÇΩ</td>
        <td>{{ "%.0f"|format(o.blogger_fee) if o.blogger_fee else '0' }} ‚ÇΩ</td>
        <td>{{ "%.0f"|format(o.cost - o.blogger_fee) if o.cost else '0' }} ‚ÇΩ</td>
        <td>
          {% if o.status == 'negotiation' %}
            <span class="badge bg-warning">–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏</span>
          {% elif o.status == 'agreed' %}
            <span class="badge bg-primary">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω</span>
          {% elif o.status == 'paid' %}
            <span class="badge bg-success">–û–ø–ª</span>
          {% elif o.status == 'published' %}
            <span class="badge bg-info">–í—ã–ª–æ–∂–∏–ª</span>
          {% else %}
            <span class="badge bg-secondary">{{ o.status }}</span>
          {% endif %}
        </td>
        <td>
          <div class="notes-cell">
            <div class="notes-view">
              <small class="notes-text" 
                     onclick="enableEdit({{ o.id }})"
                     style="cursor: pointer;"
                     title="–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è">
                {% if o.notes %}
                  {{ o.notes[:50] }}{% if o.notes|length > 50 %}...{% endif %}
                {% else %}
                  <span class="text-muted">+ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</span>
                {% endif %}
              </small>
            </div>
            <div class="notes-edit" style="display: none;">
              <textarea class="form-control form-control-sm notes-textarea" 
                        id="notes-{{ o.id }}" 
                        rows="2">{{ o.notes or '' }}</textarea>
              <div class="mt-1">
                <button class="btn btn-sm btn-success" onclick="saveNotes({{ o.id }})">‚úì</button>
                <button class="btn btn-sm btn-secondary" onclick="cancelEdit({{ o.id }})">‚úï</button>
              </div>
            </div>
          </div>
        </td>
        <td>
          <a href="/order/{{ o.id }}/edit" class="btn btn-sm btn-primary" title="–ü–æ–ª–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ">–†–µ–¥.</a>
          <form action="/order/{{ o.id }}/delete" method="post" style="display:inline;">
            <button class="btn btn-sm btn-danger" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å?');">X</button>
          </form>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

{# –ü–ê–ì–ò–ù–ê–¶–ò–Ø –î–õ–Ø –°–î–ï–õ–û–ö #}
{% if orders.pages > 1 %}
<div class="mt-4">
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if orders.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('orders', page=orders.prev_num) }}">‚Üê –ù–∞–∑–∞–¥</a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">‚Üê –ù–∞–∑–∞–¥</span>
            </li>
            {% endif %}
            
            {% for page_num in orders.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
                {% if page_num %}
                    {% if page_num == orders.page %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                    {% else %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('orders', page=page_num) }}">{{ page_num }}</a>
                    </li>
                    {% endif %}
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                {% endif %}
            {% endfor %}
            
            {% if orders.has_next %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('orders', page=orders.next_num) }}">–í–ø–µ—Ä–µ–¥ ‚Üí</a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">–í–ø–µ—Ä–µ–¥ ‚Üí</span>
            </li>
            {% endif %}
        </ul>
    </nav>
</div>
{% endif %}

<style>
.notes-cell {
  min-width: 200px;
  max-width: 300px;
}
.notes-text {
  word-break: break-word;
}
.notes-textarea {
  font-size: 0.875em;
  resize: vertical;
}
</style>

<script>
function enableEdit(orderId) {
  document.querySelectorAll('.notes-edit').forEach(el => {
    el.style.display = 'none';
  });
  document.querySelectorAll('.notes-view').forEach(el => {
    el.style.display = 'block';
  });
  
  const row = document.getElementById('order-' + orderId);
  row.querySelector('.notes-view').style.display = 'none';
  row.querySelector('.notes-edit').style.display = 'block';
  row.querySelector('.notes-textarea').focus();
}

function cancelEdit(orderId) {
  const row = document.getElementById('order-' + orderId);
  row.querySelector('.notes-view').style.display = 'block';
  row.querySelector('.notes-edit').style.display = 'none';
}

function saveNotes(orderId) {
  const textarea = document.getElementById('notes-' + orderId);
  const notes = textarea.value.trim();
  
  fetch('/order/' + orderId + '/notes', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      notes: notes
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const notesView = document.querySelector('#order-' + orderId + ' .notes-text');
      if (notes) {
        notesView.textContent = notes.length > 50 ? notes.substring(0, 50) + '...' : notes;
        notesView.classList.remove('text-muted');
      } else {
        notesView.innerHTML = '<span class="text-muted">+ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</span>';
      }
      
      cancelEdit(orderId);
      showNotification('–ó–∞–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
    } else {
      showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
  });
}

function showNotification(message, type) {
  const alert = document.createElement('div');
  alert.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
  alert.style.position = 'fixed';
  alert.style.top = '20px';
  alert.style.right = '20px';
  alert.style.zIndex = '1000';
  alert.innerHTML = `
    ${message}
    <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
  `;
  document.body.appendChild(alert);
  
  setTimeout(() => {
    if (alert.parentElement) {
      alert.remove();
    }
  }, 3000);
}
</script>

{% endblock %}